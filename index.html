<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>User Panel</title>

  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <!-- Tailwind CDN (ok for quick deploys / GitHub Pages) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body{background:#f7f9fc;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto;color:#1a202c;margin:0;min-height:100vh}
    .container{max-width:600px;margin:0 auto;padding:1rem}
    .card{background:#fff;border-radius:1.25rem;box-shadow:0 4px 12px rgba(0,0,0,.05);padding:1.25rem;margin-bottom:1rem}
    .button-primary{background:#0088cc;color:#fff;padding:.75rem 1rem;border-radius:.75rem;font-weight:600;cursor:pointer}
    .button-primary:disabled{opacity:.5;cursor:not-allowed}
    .tab-button{padding:.5rem 1rem;border-radius:.5rem;font-weight:500;color:#555}
    .tab-button.active{background:#e0f2ff;color:#0088cc}
    .content-section{display:none}
  </style>
</head>
<body>
  <div class="container">
    <h1 class="text-3xl font-extrabold text-center mb-6 text-[#0088cc]">
      User Panel
    </h1>

    <!-- Tabs -->
    <div class="flex justify-around bg-white p-2 rounded-xl shadow-md mb-6">
      <button id="tab-dashboard"   class="tab-button active" data-target="dashboard">Dashboard</button>
      <button id="tab-tasks"       class="tab-button"        data-target="tasks-all">All Tasks</button>
      <button id="tab-withdrawals" class="tab-button"        data-target="withdrawals">Withdrawals</button>
    </div>

    <!-- Alerts -->
    <div id="alert-box" class="hidden p-3 mb-4 text-sm rounded-lg" role="alert"></div>

    <!-- DASHBOARD -->
    <section id="dashboard" class="content-section" style="display:block">
      <div class="card flex items-center gap-4">
        <img id="profile-img" class="w-16 h-16 rounded-full object-cover bg-gray-200"
             src="https://placehold.co/100x100/eeeeee/333333?text=P"
             onerror="this.src='https://placehold.co/100x100/eeeeee/333333?text=P'"/>
        <div>
          <p id="username-display" class="text-xl font-bold">Loading...</p>
          <p class="text-xs text-gray-500">ID: <span id="user-id-display">0000</span></p>
        </div>
      </div>

      <div class="grid grid-cols-2 gap-4 mb-6">
        <div class="card text-center p-4">
          <p class="text-3xl font-bold text-yellow-500" id="total-coins">0</p>
          <p class="text-sm text-gray-500">Total Coins</p>
        </div>
        <div class="card text-center p-4">
          <p class="text-3xl font-bold text-green-500" id="total-referrals">0</p>
          <p class="text-sm text-gray-500">Total Referrals</p>
        </div>
        <div class="card text-center p-4">
          <p class="text-3xl font-bold text-blue-500" id="tasks-completed">0</p>
          <p class="text-sm text-gray-500">Tasks Completed</p>
        </div>
        <div class="card text-center p-4">
          <p class="text-3xl font-bold text-red-500" id="total-withdrawals">0</p>
          <p class="text-sm text-gray-500">Total Withdrawn ($)</p>
        </div>
      </div>

      <h2 class="text-2xl font-bold mb-4 text-[#0088cc]">âš¡ Quick Tasks</h2>
      <div id="quick-tasks-list">
        <p class="text-center text-gray-500 p-4">Loading tasks...</p>
      </div>
    </section>

    <!-- TASKS -->
    <section id="tasks-all" class="content-section">
      <h2 class="text-2xl font-bold mb-4 text-[#0088cc]">ðŸ§¾ All Available Tasks</h2>
      <div id="all-tasks-list">
        <p class="text-center text-gray-500 p-4">Loading tasks...</p>
      </div>
    </section>

    <!-- WITHDRAWALS -->
    <section id="withdrawals" class="content-section">
      <h2 class="text-2xl font-bold mb-4 text-[#0088cc]">ðŸ’° Request Withdrawal</h2>
      <div class="card">
        <p class="text-lg font-semibold mb-4 text-gray-700">
          Balance: <span id="withdrawal-balance" class="text-yellow-500 font-extrabold">0 Coins</span>
        </p>

        <label class="block text-sm font-medium text-gray-700 mb-1">Payment Address / UPI ID</label>
        <input id="upi-id" class="w-full p-3 mb-4 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="example@upi or wallet address"/>

        <label class="block text-sm font-medium text-gray-700 mb-1">Withdrawal Amount (Coins)</label>
        <input id="amount" type="number" class="w-full p-3 mb-6 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" placeholder="Minimum 1000"/>

        <button id="submit-withdrawal-btn" class="button-primary w-full" onclick="submitWithdrawal()" disabled>
          Submit Request
        </button>
      </div>

      <h2 class="text-xl font-bold mt-8 mb-3 text-gray-700">Share & Earn</h2>
      <div class="card">
        <p class="text-md font-semibold mb-2">Your Referral Link:</p>
        <div class="flex gap-2">
          <input id="referral-link-input" class="flex-grow p-3 text-sm border border-gray-300 rounded-l-lg bg-gray-50" readonly value="Loading..."/>
          <button class="p-3 bg-gray-200 text-gray-600 rounded-r-lg hover:bg-gray-300" onclick="copyReferralLink()">Copy</button>
        </div>
        <p class="text-sm mt-3 text-gray-500">Total Referrals: <span id="ref-count-display" class="font-bold text-green-600">0</span></p>
      </div>
    </section>
  </div>

  <!-- App (module) -->
  <script type="module">
    // ---- Firebase SDK (RTDB) ----
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, onValue, set, update, push, transaction, get } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    // ---- Config ----
    const firebaseConfig = {
      apiKey: "AIzaSyDGoRhvD8PtRxVu8bkxdL-PGn6bbR-XTeQ",
      authDomain: "task-73eb2.firebaseapp.com",
      databaseURL: "https://task-73eb2-default-rtdb.firebaseio.com",
      projectId: "task-73eb2",
      storageBucket: "task-73eb2.firebasestorage.app",
      messagingSenderId: "195157634491",
      appId: "1:195157634491:web:6f2d72751149d93bd0289e"
    };

    // ---- Constants ----
    const APP_NAMESPACE = "tma-userpanel-default";

    // ---- State ----
    let db;
    let ENV = { mode: "detecting", uid: null, name: null, photo: "", referrerId: null, platform: "unknown" };
    let userStats = { id:"", name:"", coins:0, reffer:0, refferBy:null, tasksCompleted:0, totalWithdrawals:0 };
    let isAppReady = false;

    // ---- Utils ----
    function showAlert(message, type="success"){
      const box = document.getElementById("alert-box");
      box.textContent = message;
      box.className = `p-3 mb-4 text-sm rounded-lg ${type==="success"?"bg-green-100 text-green-800":"bg-red-100 text-red-800"}`;
      box.classList.remove("hidden");
      setTimeout(()=>box.classList.add("hidden"), 4500);
      try { Telegram?.WebApp?.showAlert?.(message); } catch {}
    }

    // Hardened tab switcher (no id math bugs)
    const tabBar = document.querySelector('.flex.justify-around');
    tabBar.addEventListener('click', (e) => {
      const btn = e.target.closest('button[data-target]');
      if (!btn) return;
      const target = btn.getAttribute('data-target');
      document.querySelectorAll('.content-section').forEach(s => s.style.display = 'none');
      const sec = document.getElementById(target);
      if (sec) sec.style.display = 'block';
      document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      try { Telegram?.WebApp?.HapticFeedback?.selectionChanged(); } catch {}
    });

    async function copyReferralLink(){
      const value = document.getElementById("referral-link-input").value;
      try {
        if (navigator.clipboard?.writeText) await navigator.clipboard.writeText(value);
        else {
          const input = document.getElementById("referral-link-input");
          input.select(); document.execCommand("copy");
        }
        showAlert("Referral link copied!", "success");
      } catch { showAlert("Copy failed", "error"); }
    }
    window.copyReferralLink = copyReferralLink;

    const Path = {
      userStats: (uid) => `${APP_NAMESPACE}/users/${uid}/stats`,
      tasks: () => `${APP_NAMESPACE}/tasks`,
      withdrawals: (uid) => `${APP_NAMESPACE}/users/${uid}/withdrawals`,
    };

    // ---- Environment detection + Telegram robust capture ----
    async function getTelegramUserSafe(){
      if (typeof Telegram === "undefined" || !Telegram.WebApp) return null;
      try { Telegram.WebApp.ready(); Telegram.WebApp.expand(); } catch {}
      // retry a few timesâ€”Android sometimes injects initDataUnsafe late
      for (let i=0;i<10;i++){
        const u = Telegram.WebApp.initDataUnsafe?.user;
        if (u?.id) {
          return {
            id: String(u.id),
            name: u.username || u.first_name || "TelegramUser",
            photo: u.photo_url || "",
            referrerId: Telegram.WebApp.initDataUnsafe?.start_param || null,
          };
        }
        await new Promise(r => setTimeout(r, 200));
      }
      return null;
    }

    function detectEnvironment(){
      // try Telegram first
      // (we fill rest inside initApp to allow async)
      const url = new URL(window.location.href);
      const refParam = url.searchParams.get("ref") || null;

      // browser fallback id (stable)
      let guid = localStorage.getItem("guest_uid");
      if (!guid){ guid = crypto.randomUUID(); localStorage.setItem("guest_uid", guid); }

      return {
        mode: "browser",
        platform: "web",
        uid: "web-" + guid,
        name: localStorage.getItem("guest_name") || "Guest",
        photo: "",
        referrerId: refParam
      };
    }

    function initFirebase(mode){
      const app = initializeApp(firebaseConfig);
      if (mode === "telegram"){
        // Telegram WebView often blocks websockets: force HTTP long-polling
        db = getDatabase(app, { experimentalForceLongPolling: true });
        try { db._repoInfo_.forceWebSockets = false; } catch {}
        console.log("RTDB: Telegram mode (HTTP long-polling).");
      } else {
        db = getDatabase(app); // default transport in normal browsers
        console.log("RTDB: Browser mode (default transport).");
      }
    }

    async function handleUserSetup(uid, referrer){
      const userRef = ref(db, Path.userStats(uid));
      try{
        const snap = await get(userRef);
        if (!snap.exists()){
          const initial = {
            id: uid,
            name: ENV.name,
            photo: ENV.photo || "",
            platform: ENV.platform,
            coins: 0,
            reffer: 0,
            tasksCompleted: 0,
            totalWithdrawals: 0,
            refferBy: (referrer && referrer !== uid) ? referrer : null,
            joinedAt: new Date().toISOString(),
          };
          await set(userRef, initial);

          if (referrer && referrer !== uid){
            const refRef = ref(db, Path.userStats(referrer));
            await transaction(refRef, (data)=>{
              if (data) data.reffer = (data.reffer || 0) + 1;
              return data;
            });
          }
        } else {
          await update(userRef, {
            name: ENV.name, photo: ENV.photo || "", platform: ENV.platform, lastLogin: new Date().toISOString()
          });
        }
      }catch(e){
        console.error("User setup failed:", e);
        showAlert("User setup failed. Check console.", "error");
      }

      // referral link per mode
      const input = document.getElementById("referral-link-input");
      if (ENV.mode === "telegram"){
        input.value = `https://t.me/your_bot_username?start=${uid}`;
      } else {
        input.value = `${location.origin}${location.pathname}?ref=${uid}`;
      }
    }

    function subscribeToUserData(uid){
      const userRef = ref(db, Path.userStats(uid));
      onValue(userRef, (snap)=>{
        const data = snap.val();
        if (!data) return;
        userStats = { ...userStats, ...data };

        document.getElementById("profile-img").src = (ENV.photo || 'https://placehold.co/100x100/eeeeee/333333?text=P');
        document.getElementById("username-display").textContent = userStats.name || ENV.name;
        document.getElementById("user-id-display").textContent = userStats.id;
        document.getElementById("total-coins").textContent = (userStats.coins||0).toLocaleString();
        document.getElementById("total-referrals").textContent = (userStats.reffer||0).toLocaleString();
        document.getElementById("tasks-completed").textContent = (userStats.tasksCompleted||0).toLocaleString();
        document.getElementById("total-withdrawals").textContent = Number(userStats.totalWithdrawals||0).toFixed(2);
        document.getElementById("withdrawal-balance").textContent = `${(userStats.coins||0).toLocaleString()} Coins`;
        document.getElementById("ref-count-display").textContent = (userStats.reffer||0);
        document.getElementById("submit-withdrawal-btn").disabled = (userStats.coins||0) < 1000;
      }, (err)=>{
        console.error("Error listening to user data:", err);
        showAlert("Error loading user data.", "error");
      });
    }

    function subscribeToTasks(){
      const tasksRef = ref(db, Path.tasks());
      onValue(tasksRef, (snap)=>{
        const obj = snap.val() || {};
        const tasks = Object.entries(obj).map(([id, t])=>({ id, ...t }));
        renderTasks(tasks);
      }, (err)=>{
        console.error("Error listening to tasks:", err);
        showAlert("Error loading tasks.", "error");
      });
    }

    function renderTasks(tasks){
      const quickWrap = document.getElementById("quick-tasks-list");
      const allWrap   = document.getElementById("all-tasks-list");

      if (!tasks.length){
        quickWrap.innerHTML = '<p class="text-center text-gray-500 p-4">No tasks available.</p>';
        allWrap.innerHTML   = '<p class="text-center text-gray-500 p-4">No tasks available.</p>';
        return;
      }
      const card = (t,isQuick)=>`
        <div class="card p-4 flex items-center justify-between gap-3">
          <div>
            <h3 class="text-lg font-semibold">${t.name}</h3>
            <p class="text-sm text-gray-500 mt-1">Reward:
              <span class="text-yellow-600 font-bold">${Number(t.reward||0).toLocaleString()} Coins</span>
            </p>
            ${t.link?`<a class="text-xs text-[#0088cc] hover:underline mt-1 block" href="${t.link}" target="_blank" rel="noopener">Open Link ${isQuick?'(Quick)': ''}</a>`:''}
          </div>
          <button class="button-primary text-sm px-3 py-2" onclick="claimReward('${t.id}', ${Number(t.reward||0)})">
            Claim
          </button>
        </div>
      `;
      quickWrap.innerHTML = tasks.slice(0,3).map(t=>card(t,true)).join("");
      allWrap.innerHTML   = tasks.map(t=>card(t,false)).join("");
    }

    // ---- Actions ----
    window.claimReward = async function(taskId, reward){
      if (!isAppReady) return showAlert("App is initializing, try again.", "error");
      const userRef = ref(db, Path.userStats(ENV.uid));
      try{
        await transaction(userRef, (curr)=>{
          if (!curr) return curr;
          curr.coins = (curr.coins||0) + (reward||0);
          curr.tasksCompleted = (curr.tasksCompleted||0) + 1;
          return curr;
        });
        showAlert(`+${reward} coins added!`, "success");
        try { Telegram?.WebApp?.HapticFeedback?.notificationOccurred("success"); } catch {}
      }catch(e){
        console.error("Reward failed:", e);
        showAlert("Failed to claim reward.", "error");
      }
    };

    window.submitWithdrawal = async function(){
      if (!isAppReady) return showAlert("App is initializing, try again.", "error");
      const upi = String(document.getElementById("upi-id").value||"").trim();
      const amount = parseInt(document.getElementById("amount").value, 10);
      const btn = document.getElementById("submit-withdrawal-btn");

      if (!upi || !amount || amount<=0) return showAlert("Enter valid address & amount.", "error");
      if ((userStats.coins||0) < amount) return showAlert("Insufficient balance.", "error");
      if (amount < 1000) return showAlert("Minimum withdrawal is 1000 coins.", "error");

      btn.disabled = true; btn.textContent = "Processingâ€¦";
      const userRef = ref(db, Path.userStats(ENV.uid));
      const wRef = ref(db, Path.withdrawals(ENV.uid));

      try{
        await transaction(userRef, (curr)=>{
          if (!curr) return curr;
          if ((curr.coins||0) < amount) return curr; // abort (no change means not committed)
          curr.coins = (curr.coins||0) - amount;
          return curr;
        });

        const entry = push(wRef);
        await set(entry, {
          userId: ENV.uid,
          name: userStats.name || ENV.name,
          payment_address: upi,
          amount,
          status: "pending",
          requestedAt: new Date().toISOString(),
          platform: ENV.platform
        });

        showAlert("Withdrawal request submitted!", "success");
        document.getElementById("upi-id").value = "";
        document.getElementById("amount").value = "";
      }catch(e){
        console.error("Withdrawal failed:", e);
        showAlert("Failed to submit withdrawal.", "error");
      }finally{
        btn.disabled = (userStats.coins||0) < 1000;
        btn.textContent = "Submit Request";
      }
    };

    // ---- Init ----
    async function initApp(){
      // start with browser defaults; we may upgrade to telegram if available
      ENV = detectEnvironment();

      // try Telegram capture (if opened via WebApp button)
      const tg = await getTelegramUserSafe();
      if (tg) {
        ENV = { ...ENV, mode: "telegram", platform: "telegram", uid: tg.id, name: tg.name, photo: tg.photo, referrerId: tg.referrerId };
      }

      // Firebase transport per mode
      initFirebase(ENV.mode);

      // Bootstrap
      await handleUserSetup(ENV.uid, ENV.referrerId);
      subscribeToUserData(ENV.uid);
      subscribeToTasks();

      isAppReady = true;
      console.log("App ready:", ENV);

      window.addEventListener("offline", ()=>showAlert("You are offline.", "error"));
      window.addEventListener("online",  ()=>showAlert("Back online.", "success"));
    }

    window.onload = initApp;
  </script>
</body>
</html>